unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, System.Zip,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, ShellAPI;

type
  TForm1 = class(TForm)
    edtCaminho: TEdit;
    btnBuscar: TButton;
    OpenDialog1: TOpenDialog;
    btnIniciar: TButton;
    Memo1: TMemo;
    lblStatus: TLabel;
    edtDestino: TEdit;
    btnSalvarEm: TButton;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    procedure btnBuscarClick(Sender: TObject);
    procedure btnSalvarEmClick(Sender: TObject);
    procedure btnIniciarClick(Sender: TObject);
  private
    procedure ZipDatabase(const DBPath, DestZip: string);
    procedure GerarBackupGBAK(const DBPath, DestGbk: string);
  public
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.btnBuscarClick(Sender: TObject);
begin
  OpenDialog1.Filter := 'Firebird Database (*.fdb)|*.fdb';
  if OpenDialog1.Execute then
    edtCaminho.Text := OpenDialog1.FileName;
end;

procedure TForm1.btnSalvarEmClick(Sender: TObject);
begin
  OpenDialog1.Title := 'Escolha o local para salvar o backup';
  OpenDialog1.FileName := 'backup.gbk';
  OpenDialog1.Filter := 'Firebird Backup (*.gbk)|*.gbk';
  OpenDialog1.Options := [ofOverwritePrompt, ofCreatePrompt];

  if OpenDialog1.Execute then
    edtDestino.Text := OpenDialog1.FileName;
end;

procedure TForm1.btnIniciarClick(Sender: TObject);
var
  DBPath, DestPath, ZipFile, GbkFile: string;
begin
  Memo1.Lines.Clear;

  DBPath := edtCaminho.Text;
  DestPath := edtDestino.Text;

  if not FileExists(DBPath) then
  begin
    ShowMessage('Banco de dados não encontrado!');
    Exit;
  end;

  if DestPath = '' then
  begin
    ShowMessage('Informe o caminho de destino do backup.');
    Exit;
  end;

  // Cria caminho do .zip com base no destino informado
  ZipFile := ChangeFileExt(DestPath, '.zip');
  GbkFile := ChangeFileExt(DestPath, '.gbk');

  Memo1.Lines.Add('Compactando banco de dados...');
  lblStatus.Caption := 'Compactando banco...';
  ZipDatabase(DBPath, ZipFile);
  Memo1.Lines.Add('Arquivo ZIP criado em: ' + ZipFile);

  Memo1.Lines.Add('Gerando backup .gbk...');
  lblStatus.Caption := 'Gerando backup .gbk...';
  GerarBackupGBAK(DBPath, GbkFile);
  Memo1.Lines.Add('Backup .gbk gerado em: ' + GbkFile);

  lblStatus.Caption := 'Backup finalizado com sucesso!';
end;

procedure TForm1.ZipDatabase(const DBPath, DestZip: string);
var
  ZipFile: TZipFile;
begin
  ZipFile := TZipFile.Create;
  try
    ZipFile.Open(DestZip, zmWrite);
    ZipFile.Add(DBPath, ExtractFileName(DBPath));
    ZipFile.Close;
  finally
    ZipFile.Free;
  end;
end;

procedure TForm1.GerarBackupGBAK(const DBPath, DestGbk: string);
var
  GbakPath, DBUser, DBPass, CommandLine: string;
begin
  GbakPath := 'C:\Program Files\Firebird\Firebird_3_0\bin\gbak.exe';
  DBUser := 'SYSDBA';
  DBPass := 'masterkey';

  if not FileExists(GbakPath) then
  begin
    Memo1.Lines.Add('Erro: gbak.exe não encontrado!');
    Exit;
  end;

  CommandLine := Format('"%s" -b -user %s -pass %s "%s" "%s"',
    [GbakPath, DBUser, DBPass, DBPath, DestGbk]);

  ShellExecute(0, 'open', 'cmd.exe', PChar('/C ' + CommandLine), nil, SW_HIDE);
end;

end.

